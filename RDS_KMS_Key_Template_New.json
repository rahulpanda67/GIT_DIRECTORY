{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Template to create a RDS KMS Key",
    "Parameters": {
        "MasterKeyAlias": {
            "Description": "Alias for the master key",
            "Type": "String",
            "ConstraintDescription": "The Alias must be uniqueue in the region.",
            "Default": "rds-kms-key"
        },
        "Description": {
            "Description": "Description of the KMS Key",
            "Type": "String",
            "Default": "RDS KMS Key"
        },
        "ApplicationId": {
            "Description": "The Application ID ex APXXXXX",
            "AllowedPattern": "^((AP|IN)\\d{6})$",
            "Type": "String",
            "ConstraintDescription": "Application ID must be Caps AP+6 digits or Caps IN+6 digits, no spaces"
        },
        "ApplicationName": {
            "Type": "String",
            "Description": "The Application Name as per Service Now",
            "MaxLength": "100",
            "MinLength": "5"
        },
        "CreatedBy": {
            "Type": "String",
            "Description": "Corporate UserID or Service Account ID that is deploying the specific resource",
            "AllowedPattern": "^(a\\d{6}|srvAP\\d{6}\\w{3,8})$",
            "ConstraintDescription": "Created by must be lower case a+6 digits, no spaces, or Service Account ID obtained from MyAccess"
        },
        "Environment": {
            "Type": "String",
            "Description": "Environment to which the resource was deployed",
            "AllowedValues": [ "dev", "dit", "sit", "uat", "prod", "dr", "blueuat", "greenprod", "blueprod" ],
            "ConstraintDescription": "Environment must be one of the available values."
        },
        "Organization": {
            "Type": "String",
            "Description": "Business Unit that owns the application",
            "AllowedValues": [ "CTG", "ECC", "ECS", "PI", "FI" ],
            "ConstraintDescription": "Organization must be one of the available values."
        },
        "TimeStamp": {
            "Type": "String",
            "Description": "The Date and Time the AWS resource was created in Format :: YYYY-MM-DD HH:MM:SS",
            "AllowedPattern": "^\\d{4}(-\\d{2}){2}T(\\d{2}:){2}\\d{2}Z$",
            "ConstraintDescription": "Date and Time of creation format must be YYYY-MM-DD HH:MM:SS"
        },
        "CostCenter": {
            "Type": "String",
            "Description": "Business Cost Center for the Application",
            "AllowedPattern": "^(\\d{5})$",
            "ConstraintDescription": "Cost Center must be 5 digit number"
        },
        "Owner": {
            "Type": "String",
            "Description": "Owner of this AWS resource. May or may not be the same as Created By Field."
        },
        "ResourceTag": {
            "Type": "String",
            "Description": "Standard resource tag your role owns"
        }
    },
    "Resources": {
        "RDSKMSKey": {
            "Type": "AWS::KMS::Key",
            "DeletionPolicy": "Retain",
            "Properties": {
                "Description": { "Ref": "Description" },
                "Enabled": "True",
                "EnableKeyRotation": "true",
                "Tags": [
                    { "Key": "Name", "Value": { "Ref": "MasterKeyAlias" } },
                    { "Key": "StackName", "Value": { "Ref": "AWS::StackName" } },
                    { "Key": "ApplicationId", "Value": { "Ref": "ApplicationId" } },
                    { "Key": "CreatedBy", "Value": { "Ref": "CreatedBy" } },
                    { "Key": "Owner", "Value": { "Ref": "Owner" } },
                    { "Key": "ApplicationName", "Value": { "Ref": "ApplicationName" } },
                    { "Key": "Description", "Value": { "Ref": "Description" } },
                    { "Key": "Environment", "Value": { "Ref": "Environment" } },
                    { "Key": "TimeStamp", "Value": { "Ref": "TimeStamp" } },
                    { "Key": "CostCenter", "Value": { "Ref": "CostCenter" } },
                    { "Key": "dev-rs-tag", "Value": { "Ref": "ResourceTag" } },
                    { "Key": "Organization", "Value": { "Ref": "Organization" } }
                ],
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Id": "key-default-1",
                    "Statement": [
                        {
                            "Sid": "Must allow to root to use of the key",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": "arn:aws:iam::863914133385:root"
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Deny Delete",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": [
                                "kms:ScheduleKeyDeletion",
                                "kms:DeleteCustomKeyStore",
                                "kms:DeleteImportedKeyMaterial"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Deny Administration of the key",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": [
                                "kms:CreateAlias",
                                "kms:CreatedKey",
                                "kms:Enabled",
                                "kms:Put*",
                                "kms:Update",
                                "kms:Disable",
                                "kms:Delete",
                                "kms:Import",
                                "kms:CancelKeyDeletion"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringNotLike": {
                                    "aws:PrincipalArn": [
                                        "arn:aws:iam::863914133385:root"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        "RDSKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": "alias/${MasterKeyAlias",
                "TargetKeyId": {"Ref": "RDSKMSKey"}
            }
        }
    }    
}
